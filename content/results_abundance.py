"""Abundance (ProteomicsLFQ) Results Page."""
import streamlit as st
import pandas as pd
from pathlib import Path
from src.common.common import page_setup
from src.common.results_helpers import get_workflow_dir, get_abundance_data

params = page_setup()
st.title("Abundance Quantification")

st.markdown(
    """
View protein and PSM-level quantification from **ProteomicsLFQ**.
This page calculates differential expression statistics between sample groups.
"""
)

if "workspace" not in st.session_state:
    st.warning("Please initialize your workspace first.")
    st.stop()

workflow_dir = get_workflow_dir(st.session_state["workspace"])
quant_dir = workflow_dir / "results" / "quant_results"

if not quant_dir.exists():
    st.info("No quantification results available yet. Please run the workflow first.")
    st.page_link("content/workflow_run.py", label="Go to Run", icon="ðŸš€")
    st.stop()

csv_files = sorted(quant_dir.glob("*.csv"))

if not csv_files:
    st.info("No CSV files found in the quantification directory.")
    st.stop()

csv_file = csv_files[0]

protein_tab, psm_tab = st.tabs(["Protein Table", "PSM-level Quantification Table"])

try:
    df = pd.read_csv(csv_file)

    if df.empty:
        st.info("No data found in this file.")
        st.stop()

    with protein_tab:
        st.markdown("### Protein-Level Abundance Table")

        st.info(
            "This protein-level table is generated by grouping all PSMs that map to the "
            "same protein and aggregating their intensities across samples.\n\n"
            "Additionally, log2 fold change and p-values are calculated between sample groups."
        )

        result = get_abundance_data(st.session_state["workspace"])
        if result is None:
            st.warning("Could not compute abundance data. Please ensure sample groups are defined in the Configure page.")
            st.page_link("content/workflow_configure.py", label="Go to Configure", icon="âš™ï¸")
            st.stop()

        pivot_df, expr_df, group_map = result

        # Display group comparison info
        groups = sorted(set(group_map.values()))
        if len(groups) >= 2:
            group1, group2 = sorted(groups)[:2]
            st.info(f"Statistical comparison: **{group2} vs {group1}**")

        st.dataframe(
            pivot_df.sort_values("p-value"),
            use_container_width=True,
        )

    with psm_tab:
        st.markdown("### PSM-level Quantification Table")
        st.info(
            "This table shows the PSM-level quantification data, including protein IDs, "
            "peptide sequences, charge states, and intensities across samples. "
            "Each row represents one peptide-spectrum match detected from the MS/MS analysis."
        )
        st.dataframe(df, use_container_width=True)

except Exception as e:
    st.error(f"Failed to load {csv_file.name}: {e}")

st.markdown("---")
st.markdown("**Next steps:** Explore statistical visualizations")
col1, col2, col3 = st.columns(3)
with col1:
    st.page_link("content/results_volcano.py", label="Volcano Plot", icon="ðŸŒ‹")
with col2:
    st.page_link("content/results_pca.py", label="PCA", icon="ðŸ“Š")
with col3:
    st.page_link("content/results_heatmap.py", label="Heatmap", icon="ðŸ”¥")
